(()=>{"use strict";var e,t={21:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var i=n(481),o=n.n(i);const a=new class{#e=null;#t=[];#n=[-6.2088,106.8456];#i=13;constructor(){delete o().Icon.Default.prototype._getIconUrl,o().Icon.Default.mergeOptions({iconRetinaUrl:n(272),iconUrl:n(927),shadowUrl:n(980)})}initializeMap(e,t={}){const{center:n=this.#n,zoom:i=this.#i}=t;this.#e=o().map(e).setView(n,i),o().tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.#e),o().tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"});const a={"Street View":o().tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}),"Satellite View":o().tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})};return o().control.layers(a).addTo(this.#e),this.#e}addMarker(e,t,n={}){const i=o().marker([e,t],n).addTo(this.#e);return this.#t.push(i),i}removeMarker(e){const t=this.#t.indexOf(e);t>-1&&(this.#t.splice(t,1),this.#e.removeLayer(e))}clearMarkers(){this.#t.forEach(e=>this.#e.removeLayer(e)),this.#t=[]}setView(e,t,n){this.#e.setView([e,t],n)}on(e,t){this.#e.on(e,t)}getMap(){return this.#e}}},551:(e,t,n)=>{const i="https://story-api.dicoding.dev/v1";const o=new class{async register(e,t,n){const o=await fetch(`${i}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:n})}),a=await o.json();if(!o.ok)throw new Error(a.message);return a}async login(e,t){const n=await fetch(`${i}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),o=await n.json();if(!n.ok)throw new Error(o.message);return o}async getAllStories(e){const t=await fetch(`${i}/stories`,{headers:{Authorization:`Bearer ${e}`}}),n=await t.json();if(!t.ok)throw new Error(n.message);return n.listStory}async addStory(e,{description:t,photo:n,lat:o,lon:a}){const r=new FormData;r.append("description",t),r.append("photo",n),o&&a&&(r.append("lat",o.toString()),r.append("lon",a.toString()));const s=await fetch(`${i}/stories`,{method:"POST",headers:{Authorization:`Bearer ${e}`},body:r}),c=await s.json();if(!s.ok)throw new Error(c.message);return c}};class a{constructor(e="StoryAppDB",t=1){this.dbName=e,this.version=t,this.db=null}async init(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>{console.error("[IndexedDB] Error opening database"),t(n.error)},n.onsuccess=()=>{this.db=n.result,console.log("[IndexedDB] Database opened successfully"),e(this.db)},n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("stories")){const e=t.createObjectStore("stories",{keyPath:"id"});e.createIndex("email","email",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),console.log("[IndexedDB] Created stories object store")}t.objectStoreNames.contains("pendingStories")||(t.createObjectStore("pendingStories",{keyPath:"id",autoIncrement:!0}),console.log("[IndexedDB] Created pendingStories object store")),t.objectStoreNames.contains("pushSubscription")||(t.createObjectStore("pushSubscription",{keyPath:"key"}),console.log("[IndexedDB] Created pushSubscription object store")),t.objectStoreNames.contains("cache")||(t.createObjectStore("cache",{keyPath:"url"}),console.log("[IndexedDB] Created cache object store"))}})}async addStory(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["stories"],"readwrite").objectStore("stories").put(e);i.onsuccess=()=>{console.log("[IndexedDB] Story saved:",e.id),t(i.result)},i.onerror=()=>{console.error("[IndexedDB] Error saving story"),n(i.error)}})}async getAllStories(){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["stories"],"readonly").objectStore("stories").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=()=>{console.error("[IndexedDB] Error fetching stories"),t(n.error)}})}async getStory(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["stories"],"readonly").objectStore("stories").get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{console.error("[IndexedDB] Error fetching story"),n(i.error)}})}async deleteStory(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["stories"],"readwrite").objectStore("stories").delete(e);i.onsuccess=()=>{console.log("[IndexedDB] Story deleted:",e),t()},i.onerror=()=>{console.error("[IndexedDB] Error deleting story"),n(i.error)}})}async clearStories(){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["stories"],"readwrite").objectStore("stories").clear();n.onsuccess=()=>{console.log("[IndexedDB] All stories cleared"),e()},n.onerror=()=>{console.error("[IndexedDB] Error clearing stories"),t(n.error)}})}async searchStories(e={}){return(await this.getAllStories()).filter(t=>{if(e.query){const n=e.query.toLowerCase(),i=t.name?.toLowerCase().includes(n),o=t.description?.toLowerCase().includes(n);if(!i&&!o)return!1}return!e.email||t.email===e.email})}async addPendingStory(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["pendingStories"],"readwrite").objectStore("pendingStories").add(e);i.onsuccess=()=>{console.log("[IndexedDB] Pending story saved:",i.result),t(i.result)},i.onerror=()=>{console.error("[IndexedDB] Error saving pending story"),n(i.error)}})}async getPendingStories(){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["pendingStories"],"readonly").objectStore("pendingStories").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=()=>{console.error("[IndexedDB] Error fetching pending stories"),t(n.error)}})}async deletePendingStory(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["pendingStories"],"readwrite").objectStore("pendingStories").delete(e);i.onsuccess=()=>{console.log("[IndexedDB] Pending story deleted:",e),t()},i.onerror=()=>{console.error("[IndexedDB] Error deleting pending story"),n(i.error)}})}async savePushSubscription(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["pushSubscription"],"readwrite").objectStore("pushSubscription").put({key:"subscription",data:e,timestamp:(new Date).getTime()});i.onsuccess=()=>{console.log("[IndexedDB] Push subscription saved"),t()},i.onerror=()=>{console.error("[IndexedDB] Error saving push subscription"),n(i.error)}})}async getPushSubscription(){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["pushSubscription"],"readonly").objectStore("pushSubscription").get("subscription");n.onsuccess=()=>{e(n.result?.data||null)},n.onerror=()=>{console.error("[IndexedDB] Error fetching push subscription"),t(n.error)}})}async deletePushSubscription(){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["pushSubscription"],"readwrite").objectStore("pushSubscription").delete("subscription");n.onsuccess=()=>{console.log("[IndexedDB] Push subscription deleted"),e()},n.onerror=()=>{console.error("[IndexedDB] Error deleting push subscription"),t(n.error)}})}async cacheData(e,t){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((n,i)=>{const o=this.db.transaction(["cache"],"readwrite").objectStore("cache").put({url:e,data:t,timestamp:(new Date).getTime()});o.onsuccess=()=>{n()},o.onerror=()=>{i(o.error)}})}async getCachedData(e){if(!this.db)throw new Error("[IndexedDB] Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction(["cache"],"readonly").objectStore("cache").get(e);i.onsuccess=()=>{t(i.result?.data||null)},i.onerror=()=>{n(i.error)}})}close(){this.db&&(this.db.close(),console.log("[IndexedDB] Database closed"))}}var r=n(21);class s{constructor(){this.serviceWorkerReady=!1,this.subscribed=!1}async init(){if(!("serviceWorker"in navigator))return console.warn("[PushNotification] Service Worker not supported"),!1;if(!("PushManager"in window))return console.warn("[PushNotification] Push Manager not supported"),!1;try{const e=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"});console.log("[PushNotification] Service Worker registered",e),this.serviceWorkerReady=!0;const t=await e.pushManager.getSubscription();return this.subscribed=null!==t,!0}catch(e){return console.error("[PushNotification] Service Worker registration failed:",e),!1}}async requestPermission(){if(!("Notification"in window))return console.warn("[PushNotification] Notification not supported"),!1;if("granted"===Notification.permission)return!0;if("denied"===Notification.permission)return console.warn("[PushNotification] Notification permission denied"),!1;try{return"granted"===await Notification.requestPermission()}catch(e){return console.error("[PushNotification] Permission request failed:",e),!1}}async subscribe(e){if(!this.serviceWorkerReady)return console.error("[PushNotification] Service Worker not ready"),null;try{const t=await navigator.serviceWorker.ready,n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(e)});return console.log("[PushNotification] Subscription successful",n),this.subscribed=!0,n}catch(e){return console.error("[PushNotification] Subscription failed:",e),null}}async unsubscribe(){if(!this.serviceWorkerReady)return console.error("[PushNotification] Service Worker not ready"),!1;try{const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();return!!t&&(await t.unsubscribe(),console.log("[PushNotification] Unsubscription successful"),this.subscribed=!1,!0)}catch(e){return console.error("[PushNotification] Unsubscription failed:",e),!1}}async getSubscription(){if(!this.serviceWorkerReady)return null;try{const e=await navigator.serviceWorker.ready;return await e.pushManager.getSubscription()}catch(e){return console.error("[PushNotification] Failed to get subscription:",e),null}}async isSubscribed(){return null!==await this.getSubscription()}urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}async sendSubscriptionToServer(e,t){try{const n=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(!n.ok)throw new Error(`Server error: ${n.statusText}`);const i=await n.json();return console.log("[PushNotification] Subscription sent to server:",i),i}catch(e){throw console.error("[PushNotification] Failed to send subscription to server:",e),e}}async showLocalNotification(e,t={}){if(this.serviceWorkerReady)try{const n=await navigator.serviceWorker.ready;await n.showNotification(e,{icon:"/favicon.png",badge:"/favicon.png",tag:"story-notification",requireInteraction:!1,...t})}catch(e){console.error("[PushNotification] Failed to show notification:",e)}else console.error("[PushNotification] Service Worker not ready")}}const c={"/":new class{#e=null;#o=[];#a=null;#r=new a;async render(){return'\n      <section class="container home-page">\n        <div class="page-header">\n          <div class="header-content">\n            <h1>Story Map</h1>\n            <div class="header-status">\n              <span id="connection-status" class="connection-indicator online" title="Online status"></span>\n              <button id="logout-button" class="logout-button">Logout</button>\n            </div>\n          </div>\n          <button id="add-story-button" class="add-story-button">Add New Story</button>\n        </div>\n        <div class="content-wrapper">\n          <div class="story-list" id="story-list">\n            <h2>Stories</h2>\n            <div class="stories-container">Loading stories...</div>\n          </div>\n          <div class="map-container">\n            <div id="map"></div>\n          </div>\n        </div>\n      </section>\n    '}async afterRender(){if(!localStorage.getItem("token"))return void(window.location.hash="#/login");try{await this.#r.init()}catch(e){console.error("[HomePage] Error initializing IndexedDB:",e)}this._updateConnectionStatus(),window.addEventListener("online",()=>this._updateConnectionStatus()),window.addEventListener("offline",()=>this._updateConnectionStatus());document.getElementById("logout-button").addEventListener("click",()=>{localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("name"),window.location.hash="#/login"});document.getElementById("add-story-button").addEventListener("click",()=>{window.location.hash="#/add"}),await this._initializeMap(),await this._loadStories()}async _initializeMap(){const{default:e}=await Promise.resolve().then(n.bind(n,21));this.#e=e.initializeMap("map")}async _loadStories(){try{const e=localStorage.getItem("token"),t=navigator.onLine;let n=[];if(t)try{n=await o.getAllStories(e),this.#o=n;for(const e of n)await this.#r.addStory(e)}catch(e){console.error("[HomePage] Error fetching from API:",e),n=await this.#r.getAllStories()}else console.log("[HomePage] Offline: Loading from IndexedDB"),n=await this.#r.getAllStories();this.#o=n,this._renderStories(n),this._renderMarkers(n)}catch(e){console.error("[HomePage] Error loading stories:",e),document.querySelector(".stories-container").innerHTML="<p>Error loading stories. Please try again later.</p>"}}_renderStories(e){const t=document.querySelector(".stories-container");if(!e.length)return void(t.innerHTML="<p>No stories found.</p>");const i=e.map(e=>{const t=new Date(e.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return`\n        <article class="story-item ${e.id===this.#a?"active":""}" data-id="${e.id}">\n          <img src="${e.photoUrl}" alt="Photo from ${e.name}" class="story-image">\n          <div class="story-content">\n            <h3>${e.name}</h3>\n            <p class="story-description">${e.description}</p>\n            <time class="story-date">${t}</time>\n          </div>\n        </article>\n      `}).join("");t.innerHTML=i,document.querySelectorAll(".story-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id,i=this.#o.find(e=>e.id===t);if(i&&i.lat&&i.lon){const{default:e}=n(21);e.setView(i.lat,i.lon,15),this.#a=t,this._highlightActiveStory(t)}})})}_renderMarkers(e){const{default:t}=n(21);t.clearMarkers();const i=L.latLngBounds();let o=!1;e.forEach(e=>{if(e.lat&&e.lon){o=!0;const n=new Date(e.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),a=t.addMarker(e.lat,e.lon,{title:e.name});a.bindPopup(`\n          <div class="marker-popup">\n            <img src="${e.photoUrl}" alt="Photo from ${e.name}" class="popup-image">\n            <h3>${e.name}</h3>\n            <p>${e.description}</p>\n            <time class="popup-date">${n}</time>\n          </div>\n        `),a.on("click",()=>{this.#a=e.id,this._highlightActiveStory(e.id)}),i.extend([e.lat,e.lon])}}),o&&t.getMap().fitBounds(i,{padding:[50,50]})}_highlightActiveStory(e){document.querySelectorAll(".story-item").forEach(t=>{t.classList.toggle("active",t.dataset.id===e)})}_updateConnectionStatus(){const e=document.getElementById("connection-status");e&&(navigator.onLine?(e.classList.remove("offline"),e.classList.add("online"),e.title="Online",e.setAttribute("aria-label","Connection status: Online")):(e.classList.remove("online"),e.classList.add("offline"),e.title="Offline",e.setAttribute("aria-label","Connection status: Offline")))}_renderStories(e){const t=document.querySelector(".stories-container");if(!e.length)return void(t.innerHTML="<p>No stories found.</p>");const i=e.map(e=>{const t=new Date(e.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return`\n        <article class="story-item ${e.id===this.#a?"active":""}" data-id="${e.id}">\n          <img src="${e.photoUrl}" alt="Photo from ${e.name}" class="story-image">\n          <div class="story-content">\n            <h3>${e.name}</h3>\n            <p class="story-description">${e.description}</p>\n            <time class="story-date">${t}</time>\n          </div>\n        </article>\n      `}).join("");t.innerHTML=i,document.querySelectorAll(".story-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id,i=this.#o.find(e=>e.id===t);if(i&&i.lat&&i.lon){const{default:e}=n(21);e.setView(i.lat,i.lon,15),this.#a=t,this._highlightActiveStory(t)}})})}_renderMarkers(e){const{default:t}=n(21);t.clearMarkers();const i=L.latLngBounds();let o=!1;e.forEach(e=>{if(e.lat&&e.lon){o=!0;const n=new Date(e.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),a=t.addMarker(e.lat,e.lon,{title:e.name});a.bindPopup(`\n          <div class="marker-popup">\n            <img src="${e.photoUrl}" alt="Photo from ${e.name}" class="popup-image">\n            <h3>${e.name}</h3>\n            <p>${e.description}</p>\n            <time class="popup-date">${n}</time>\n          </div>\n        `),a.on("click",()=>{this.#a=e.id,this._highlightActiveStory(e.id)}),i.extend([e.lat,e.lon])}}),o&&t.getMap().fitBounds(i,{padding:[50,50]})}_highlightActiveStory(e){document.querySelectorAll(".story-item").forEach(t=>{t.classList.toggle("active",t.dataset.id===e)})}},"/about":new class{async render(){return'\n      <section class="container">\n        <h1>About Page</h1>\n      </section>\n    '}async afterRender(){}},"/add":new class{constructor(){this.selectedLocation=null,this.map=null,this.locationMarker=null,this.indexedDB=new a}async render(){return'\n      <section class="container add-story-page">\n        <h1>Add New Story</h1>\n        <div id="offline-notice" class="offline-notice" style="display: none;">\n          ‚ö†Ô∏è You are offline. Your story will be saved locally and synced when you\'re back online.\n        </div>\n        <form id="add-story-form" class="add-story-form">\n          <div class="form-group">\n            <label for="description">Story Description</label>\n            <textarea id="description" name="description" required placeholder="Tell your story..." aria-required="true"></textarea>\n          </div>\n\n          <div class="form-group">\n            <label for="photo">Photo</label>\n            <div class="photo-input-container">\n              <input type="file" id="photo" name="photo" accept="image/*" required aria-required="true">\n              <button type="button" id="camera-button" class="camera-button">Take Photo</button>\n            </div>\n            <div id="photo-preview" class="photo-preview"></div>\n          </div>\n\n          <div class="form-group">\n            <label>Location</label>\n            <div id="location-map" class="location-map"></div>\n            <p class="location-help">Click on the map to select a location for your story</p>\n          </div>\n\n          <div class="form-actions">\n            <button type="button" id="cancel-button" class="cancel-button">Cancel</button>\n            <button type="submit" class="submit-button">Share Story</button>\n          </div>\n        </form>\n      </section>\n    '}async afterRender(){if(localStorage.getItem("token")){try{await this.indexedDB.init()}catch(e){console.error("[AddStoryPage] IndexedDB init error",e)}this.updateOfflineNotice(),window.addEventListener("online",()=>this.updateOfflineNotice()),window.addEventListener("offline",()=>this.updateOfflineNotice()),this.initMap(),this.initForm(),this.initCamera()}else window.location.hash="#/login"}updateOfflineNotice(){const e=document.getElementById("offline-notice");e&&(e.style.display=navigator.onLine?"none":"block")}initMap(){this.map=r.default.initializeMap("location-map",{zoom:5}),this.map.on("click",e=>{const{lat:t,lng:n}=e.latlng;this.selectedLocation={lat:t,lng:n},this.locationMarker&&r.default.removeMarker(this.locationMarker),this.locationMarker=r.default.addMarker(t,n,{draggable:!0}),this.locationMarker.on("dragend",e=>{const t=e.target.getLatLng();this.selectedLocation={lat:t.lat,lng:t.lng}})})}initForm(){const e=document.getElementById("add-story-form"),t=document.getElementById("photo"),n=document.getElementById("photo-preview"),i=document.getElementById("cancel-button");i&&i.addEventListener("click",()=>{window.location.hash="#/"}),t&&t.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];if(!t||!n)return;const i=new FileReader;i.onload=e=>{n.innerHTML=`<img src="${e.target.result}" class="preview-image" alt="Preview">`},i.readAsDataURL(t)}),e&&e.addEventListener("submit",async t=>{t.preventDefault();const n=new FormData(e),i=n.get("description"),a=n.get("photo");if(!this.selectedLocation)return void alert("Please select a location on the map");const r=localStorage.getItem("token");if(r)if(navigator.onLine)try{await o.addStory(r,{description:i,photo:a,lat:this.selectedLocation.lat,lon:this.selectedLocation.lng}),alert("Story shared successfully!"),window.location.hash="#/"}catch(e){console.error("Add story failed, saving offline",e),await this.saveStoryOffline(i,a)}else await this.saveStoryOffline(i,a);else window.location.hash="#/login"})}async saveStoryOffline(e,t){if(!t)return void alert("Please attach a photo");const n=new FileReader;n.onload=async t=>{const n=t.target.result,i={description:e,photoData:n,lat:this.selectedLocation.lat,lon:this.selectedLocation.lng,timestamp:Date.now()};await this.indexedDB.addPendingStory(i),alert("Saved locally. It will sync when you are back online."),window.location.hash="#/"},n.readAsDataURL(t)}initCamera(){const e=document.getElementById("camera-button"),t=document.getElementById("photo-preview"),n=document.getElementById("photo");e&&e.addEventListener("click",async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:!0});t&&(t.innerHTML='<video autoplay class="camera-preview"></video><button type="button" class="capture-button">Take Photo</button>');const i=document.querySelector(".camera-preview");if(!i)return;i.srcObject=e;const o=document.querySelector(".capture-button");if(!o)return;o.addEventListener("click",()=>{const o=document.createElement("canvas");o.width=i.videoWidth,o.height=i.videoHeight,o.getContext("2d").drawImage(i,0,0),o.toBlob(i=>{const a=new File([i],"camera.jpg",{type:"image/jpeg"}),r=new DataTransfer;r.items.add(a),n&&(n.files=r.files),t&&(t.innerHTML=`<img src="${o.toDataURL()}" class="preview-image" alt="Preview">`),e.getTracks().forEach(e=>e.stop())},"image/jpeg")})}catch(e){console.error("Camera error",e),alert("Cannot access camera.")}})}},"/login":new class{async render(){return'\n      <section class="container login-page">\n        <div class="auth-container">\n          <h1>Login</h1>\n          <form id="login-form" class="auth-form">\n            <div class="form-group">\n              <label for="email">Email</label>\n              <input \n                type="email" \n                id="email" \n                name="email" \n                required \n                aria-required="true"\n                placeholder="Enter your email">\n            </div>\n\n            <div class="form-group">\n              <label for="password">Password</label>\n              <input \n                type="password" \n                id="password" \n                name="password" \n                required \n                aria-required="true"\n                placeholder="Enter your password">\n            </div>\n\n            <div class="error-message" id="error-message"></div>\n\n            <button type="submit" class="submit-button">Login</button>\n          </form>\n\n          <p class="auth-link">\n            Don\'t have an account? <button type="button" id="register-link" class="link-button">Register here</button>\n          </p>\n        </div>\n      </section>\n    '}async afterRender(){const e=document.getElementById("login-form"),t=document.getElementById("error-message");document.getElementById("register-link").addEventListener("click",()=>{window.location.hash="#/register"}),e.addEventListener("submit",async e=>{e.preventDefault();try{const e=document.getElementById("email").value,t=document.getElementById("password").value,n=await o.login(e,t);localStorage.setItem("token",n.loginResult.token),localStorage.setItem("userId",n.loginResult.userId),localStorage.setItem("name",n.loginResult.name),window.location.hash="#/"}catch(e){t.textContent=e.message||"Login failed. Please try again.",t.style.display="block"}})}},"/register":new class{async render(){return'\n      <section class="container register-page">\n        <div class="auth-container">\n          <h1>Register</h1>\n          <form id="register-form" class="auth-form">\n            <div class="form-group">\n              <label for="name">Full Name</label>\n              <input \n                type="text" \n                id="name" \n                name="name" \n                required \n                aria-required="true"\n                placeholder="Enter your full name">\n            </div>\n\n            <div class="form-group">\n              <label for="email">Email</label>\n              <input \n                type="email" \n                id="email" \n                name="email" \n                required \n                aria-required="true"\n                placeholder="Enter your email">\n            </div>\n\n            <div class="form-group">\n              <label for="password">Password</label>\n              <input \n                type="password" \n                id="password" \n                name="password" \n                required \n                aria-required="true"\n                placeholder="Enter your password (min. 6 characters)"\n                minlength="6">\n            </div>\n\n            <div class="error-message" id="error-message"></div>\n\n            <button type="submit" class="submit-button">Register</button>\n          </form>\n\n          <p class="auth-link">\n            Already have an account? <button type="button" id="login-link" class="link-button">Login here</button>\n          </p>\n        </div>\n      </section>\n    '}async afterRender(){const e=document.getElementById("register-form"),t=document.getElementById("error-message");document.getElementById("login-link").addEventListener("click",()=>{window.location.hash="#/login"}),e.addEventListener("submit",async e=>{e.preventDefault();try{const e=document.getElementById("name").value,t=document.getElementById("email").value,n=document.getElementById("password").value;await o.register(e,t,n),alert("Registration successful! Please login."),window.location.hash="#/login"}catch(e){t.textContent=e.message||"Registration failed. Please try again.",t.style.display="block"}})}},"/notifications":new class{constructor(){this.pushService=new s,this.indexedDB=new a}async render(){return'\n      <section class="container notification-settings-page">\n        <div class="settings-container">\n          <h1>Notification Settings</h1>\n          \n          <div class="settings-card">\n            <h2>Push Notifications</h2>\n            <p class="setting-description">Receive real-time notifications about new stories and updates.</p>\n            \n            <div class="setting-item">\n              <div class="setting-label">\n                <h3>Enable Push Notifications</h3>\n                <p class="setting-info" id="permission-status">Checking permission status...</p>\n              </div>\n              <button \n                id="toggle-notification-btn" \n                class="toggle-button" \n                aria-label="Toggle push notifications">\n                <span class="toggle-switch"></span>\n              </button>\n            </div>\n\n            <div class="setting-actions">\n              <button id="test-notification-btn" class="action-button" disabled>\n                üì¨ Send Test Notification\n              </button>\n              <button id="refresh-status-btn" class="action-button secondary">\n                üîÑ Refresh Status\n              </button>\n            </div>\n\n            <div class="notification-info">\n              <p><strong>Status:</strong> <span id="notification-status">Loading...</span></p>\n              <p><strong>Permission:</strong> <span id="notification-permission">Loading...</span></p>\n              <div id="subscription-info" class="subscription-details" style="display: none;">\n                <p><strong>Subscription Status:</strong> <span id="subscription-status">Active</span></p>\n                <p class="small-text">You will receive push notifications about new stories.</p>\n              </div>\n            </div>\n          </div>\n\n          <div class="settings-card faq-section">\n            <h2>FAQ</h2>\n            <details>\n              <summary>What are push notifications?</summary>\n              <p>Push notifications are messages sent to your device from the Story Map server. You\'ll receive alerts about new stories shared by other users.</p>\n            </details>\n            <details>\n              <summary>How do I enable notifications?</summary>\n              <p>Click the "Enable Push Notifications" toggle button above. Your browser will ask for permission to send notifications.</p>\n            </details>\n            <details>\n              <summary>Can I disable notifications anytime?</summary>\n              <p>Yes! Just click the toggle button to disable notifications. You can re-enable them anytime.</p>\n            </details>\n            <details>\n              <summary>Will my data be safe?</summary>\n              <p>Your subscription data is encrypted and stored securely. We only use it to send you notifications about new stories.</p>\n            </details>\n          </div>\n\n          <div class="back-button-container">\n            <button id="back-to-home-btn" class="back-button">‚Üê Back to Home</button>\n          </div>\n        </div>\n      </section>\n    '}async afterRender(){await this.indexedDB.init();const e=document.getElementById("toggle-notification-btn"),t=document.getElementById("test-notification-btn"),n=document.getElementById("refresh-status-btn"),i=document.getElementById("back-to-home-btn");if(!await this.pushService.init())return this.updateStatus("error","Push notifications are not supported on this browser"),void(e.disabled=!0);await this.updateNotificationStatus(),e.addEventListener("click",async()=>{await this.toggleSubscription()}),t.addEventListener("click",async()=>{await this.sendTestNotification()}),n.addEventListener("click",async()=>{await this.updateNotificationStatus()}),i.addEventListener("click",()=>{window.location.hash="#/"})}async updateNotificationStatus(){const e=document.getElementById("notification-status"),t=document.getElementById("notification-permission"),n=document.getElementById("toggle-notification-btn"),i=document.getElementById("test-notification-btn"),o=document.getElementById("subscription-info");try{const a=await this.pushService.isSubscribed(),r=Notification.permission;e.textContent=a?"‚úÖ Enabled":"‚ùå Disabled",t.textContent=this.formatPermission(r),a?(n.classList.add("active"),i.disabled=!1,o.style.display="block"):(n.classList.remove("active"),i.disabled=!0,o.style.display="none");const s=document.getElementById("permission-status");"granted"===r&&a?(s.textContent="‚úÖ Notifications are enabled",s.style.color="#28a745"):"denied"===r?(s.textContent="‚ùå You have denied notifications. Enable them in browser settings.",s.style.color="#dc3545",n.disabled=!0):"default"===r&&(s.textContent="‚ö†Ô∏è Click toggle to enable notifications",s.style.color="#ffc107")}catch(t){console.error("[NotificationSettings] Error updating status:",t),e.textContent="Error",e.style.color="#dc3545"}}async toggleSubscription(){const e=document.getElementById("toggle-notification-btn");e.disabled=!0;try{if(await this.pushService.isSubscribed()){await this.pushService.unsubscribe()&&(await this.indexedDB.deletePushSubscription(),alert("Push notifications have been disabled"))}else{if(!await this.pushService.requestPermission())return alert("Permission denied. Please enable notifications in your browser settings."),void(e.disabled=!1);const t="BEl62iUEL8kIAcD78j6O7u0zkz7HLEcqU8MKS0Ny2m89KBj1t_ULhfYoxKiVv0vJi0lxPKKWLXu5b3vZHgUzN7I",n=await this.pushService.subscribe(t);if(n){await this.indexedDB.savePushSubscription(n);const e=localStorage.getItem("token");if(e)try{await this.pushService.sendSubscriptionToServer(n,e)}catch(e){console.warn("[NotificationSettings] Could not send subscription to server:",e)}alert("Push notifications have been enabled!")}else alert("Failed to enable notifications. Please try again.")}await this.updateNotificationStatus()}catch(e){console.error("[NotificationSettings] Error toggling subscription:",e),alert("Error: "+e.message)}finally{e.disabled=!1}}async sendTestNotification(){try{document.getElementById("test-notification-btn").disabled=!0,await this.pushService.showLocalNotification("Test Notification",{body:"‚úÖ Push notifications are working! You will receive notifications about new stories.",tag:"test-notification",requireInteraction:!0,actions:[{action:"view-all",title:"View All Stories"},{action:"dismiss",title:"Dismiss"}]}),alert("Test notification sent!")}catch(e){console.error("[NotificationSettings] Error sending test notification:",e),alert("Error: "+e.message)}finally{document.getElementById("test-notification-btn").disabled=!1}}formatPermission(e){switch(e){case"granted":return"‚úÖ Granted";case"denied":return"‚ùå Denied";case"default":return"‚ö†Ô∏è Not Set";default:return"Unknown"}}updateStatus(e,t){const n=document.getElementById("notification-status");n&&(n.textContent=t,n.style.color="error"===e?"#dc3545":"#28a745")}},"/offline-data":new class{#r=new a;async render(){return'\n      <section class="container offline-data-page">\n        <h1>Offline Data Manager</h1>\n        \n        <div class="data-sections">\n          \x3c!-- Cached Stories Section --\x3e\n          <div class="data-section">\n            <h2>üìö Cached Stories</h2>\n            <p class="section-description">Stories saved for offline viewing</p>\n            <div id="cached-stories-container" class="data-container">\n              <p class="loading">Loading cached stories...</p>\n            </div>\n          </div>\n\n          \x3c!-- Pending Stories Section --\x3e\n          <div class="data-section">\n            <h2>‚è≥ Pending Stories</h2>\n            <p class="section-description">Stories waiting to be synced to server</p>\n            <div id="pending-stories-container" class="data-container">\n              <p class="loading">Loading pending stories...</p>\n            </div>\n            <button id="sync-pending-btn" class="action-button" style="margin-top: 1rem;">\n              üîÑ Sync Pending Stories\n            </button>\n          </div>\n\n          \x3c!-- Search & Filter Section --\x3e\n          <div class="data-section">\n            <h2>üîç Search Stories</h2>\n            <div class="search-container">\n              <input \n                type="text" \n                id="search-input" \n                placeholder="Search stories by name or description..."\n                class="search-input"\n                aria-label="Search cached stories">\n              <button id="search-btn" class="search-button">Search</button>\n              <button id="clear-search-btn" class="search-button secondary">Clear</button>\n            </div>\n            <div id="search-results-container" class="data-container" style="margin-top: 1rem; display: none;">\n              <p class="loading">Search results will appear here...</p>\n            </div>\n          </div>\n\n          \x3c!-- Database Stats Section --\x3e\n          <div class="data-section stats-section">\n            <h2>üìä Database Statistics</h2>\n            <div id="db-stats" class="stats-grid">\n              <div class="stat-item">\n                <span class="stat-label">Total Stories</span>\n                <span class="stat-value" id="total-stories">0</span>\n              </div>\n              <div class="stat-item">\n                <span class="stat-label">Pending Stories</span>\n                <span class="stat-value" id="pending-count">0</span>\n              </div>\n              <div class="stat-item">\n                <span class="stat-label">Storage Status</span>\n                <span class="stat-value" id="storage-status">Active</span>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- Actions Section --\x3e\n          <div class="data-section actions-section">\n            <h2>‚öôÔ∏è Database Actions</h2>\n            <div class="action-buttons">\n              <button id="export-data-btn" class="action-button">üì• Export Data</button>\n              <button id="clear-cache-btn" class="action-button danger">üóëÔ∏è Clear Cache</button>\n              <button id="back-home-btn" class="action-button secondary">‚Üê Back to Home</button>\n            </div>\n          </div>\n        </div>\n      </section>\n    '}async afterRender(){try{await this.#r.init()}catch(e){console.error("[OfflineDataPage] Error initializing IndexedDB:",e)}await this.loadCachedStories(),await this.loadPendingStories(),await this.updateStats(),document.getElementById("sync-pending-btn").addEventListener("click",()=>this.syncPendingStories()),document.getElementById("search-btn").addEventListener("click",()=>this.performSearch()),document.getElementById("clear-search-btn").addEventListener("click",()=>this.clearSearch()),document.getElementById("export-data-btn").addEventListener("click",()=>this.exportData()),document.getElementById("clear-cache-btn").addEventListener("click",()=>this.clearCache()),document.getElementById("back-home-btn").addEventListener("click",()=>{window.location.hash="#/"}),document.getElementById("search-input").addEventListener("keypress",e=>{"Enter"===e.key&&this.performSearch()})}async loadCachedStories(){try{const e=await this.#r.getAllStories(),t=document.getElementById("cached-stories-container");if(!e||0===e.length)return void(t.innerHTML='<p class="empty-state">No cached stories found.</p>');const n=e.map(e=>`\n        <div class="story-card">\n          <img src="${e.photoUrl}" alt="${e.name}" class="story-thumbnail" onerror="this.src='/favicon.png'">\n          <div class="story-info">\n            <h3>${e.name}</h3>\n            <p>${e.description}</p>\n            <small>Created: ${new Date(e.createdAt).toLocaleDateString()}</small>\n            <div class="story-actions">\n              <button class="delete-btn" onclick="this.closest('.offline-data-page') ? null : location.hash='#/'">Delete</button>\n            </div>\n          </div>\n        </div>\n      `).join("");t.innerHTML=n}catch(e){console.error("[OfflineDataPage] Error loading cached stories:",e),document.getElementById("cached-stories-container").innerHTML='<p class="error">Error loading cached stories</p>'}}async loadPendingStories(){try{const e=await this.#r.getPendingStories(),t=document.getElementById("pending-stories-container");if(!e||0===e.length)return void(t.innerHTML='<p class="empty-state">No pending stories to sync.</p>');const n=e.map(e=>`\n        <div class="pending-card">\n          <div class="pending-header">\n            <h3>${e.description?.substring(0,50)||"Untitled"}...</h3>\n            <span class="status-badge">Pending</span>\n          </div>\n          <p>Created: ${new Date(e.timestamp||Date.now()).toLocaleString()}</p>\n          <div class="pending-preview">\n            ${e.photoData?'<img src="'+e.photoData+'" alt="preview" class="photo-preview">':"<p>No photo</p>"}\n          </div>\n        </div>\n      `).join("");t.innerHTML=n}catch(e){console.error("[OfflineDataPage] Error loading pending stories:",e),document.getElementById("pending-stories-container").innerHTML='<p class="error">Error loading pending stories</p>'}}async performSearch(){const e=document.getElementById("search-input").value;if(e.trim())try{const t=await this.#r.searchStories({query:e}),n=document.getElementById("search-results-container");if(n.style.display="block",!t||0===t.length)return void(n.innerHTML=`<p class="empty-state">No stories found matching "${e}"</p>`);const i=t.map(e=>`\n        <div class="story-card">\n          <img src="${e.photoUrl}" alt="${e.name}" class="story-thumbnail" onerror="this.src='/favicon.png'">\n          <div class="story-info">\n            <h3>${e.name}</h3>\n            <p>${e.description}</p>\n            <small>Created: ${new Date(e.createdAt).toLocaleDateString()}</small>\n          </div>\n        </div>\n      `).join("");n.innerHTML=i}catch(e){console.error("[OfflineDataPage] Error searching stories:",e)}else this.clearSearch()}clearSearch(){document.getElementById("search-input").value="",document.getElementById("search-results-container").style.display="none",document.getElementById("search-results-container").innerHTML=""}async updateStats(){try{const e=await this.#r.getAllStories(),t=await this.#r.getPendingStories();document.getElementById("total-stories").textContent=e.length,document.getElementById("pending-count").textContent=t.length,document.getElementById("storage-status").textContent="Active ‚úì"}catch(e){console.error("[OfflineDataPage] Error updating stats:",e)}}async syncPendingStories(){const e=document.getElementById("sync-pending-btn"),t=e.disabled;e.disabled=!0,e.textContent="‚è≥ Syncing...";try{if(!navigator.onLine)return void alert("You are offline. Please reconnect to sync pending stories.");const e=localStorage.getItem("token");if(!e)return alert("Please login to sync stories."),void(window.location.hash="#/login");const t=await this.#r.getPendingStories();if(!t||0===t.length)return void alert("No pending stories to sync.");let n=0;const i=[];for(const a of t)try{await o.addStory(a.description,a.photoData,a.lat,a.lon,e),await this.#r.deletePendingStory(a.id),n++}catch(e){i.push(`Story failed: ${e.message}`)}n>0&&(alert(`Successfully synced ${n} story(ies)!`),await this.loadPendingStories(),await this.loadCachedStories(),await this.updateStats()),i.length>0&&console.error("[OfflineDataPage] Sync errors:",i)}catch(e){console.error("[OfflineDataPage] Error syncing pending stories:",e),alert("Error syncing stories: "+e.message)}finally{e.disabled=t,e.textContent="üîÑ Sync Pending Stories"}}async exportData(){try{const e=await this.#r.getAllStories(),t=await this.#r.getPendingStories(),n={exportedAt:(new Date).toISOString(),cachedStories:e,pendingStories:t},i=JSON.stringify(n,null,2),o=new Blob([i],{type:"application/json"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=`story-map-export-${Date.now()}.json`,r.click(),URL.revokeObjectURL(a),alert("Data exported successfully!")}catch(e){console.error("[OfflineDataPage] Error exporting data:",e),alert("Error exporting data: "+e.message)}}async clearCache(){if(confirm("Are you sure you want to clear all cached data? This action cannot be undone."))try{await this.#r.clearStories(),alert("Cache cleared successfully!"),await this.loadCachedStories(),await this.updateStats()}catch(e){console.error("[OfflineDataPage] Error clearing cache:",e),alert("Error clearing cache: "+e.message)}}}};function d(e){const t=e.split("/");return{resource:t[1]||null,id:t[2]||null}}function l(e){let t="";return e.resource&&(t=t.concat(`/${e.resource}`)),e.id&&(t=t.concat("/:id")),t||"/"}function u(){return location.hash.replace("#","")||"/"}const h=class{#s=null;#c=null;#d=null;constructor({navigationDrawer:e,drawerButton:t,content:n}){this.#s=n,this.#c=t,this.#d=e,this._setupDrawer()}_setupDrawer(){this.#c.addEventListener("click",()=>{const e=this.#d.classList.toggle("open");this.#c.setAttribute("aria-expanded",e.toString())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.#d.classList.contains("open")&&(this.#d.classList.remove("open"),this.#c.setAttribute("aria-expanded","false"))}),document.body.addEventListener("click",e=>{this.#d.contains(e.target)||this.#c.contains(e.target)||(this.#d.classList.remove("open"),this.#c.setAttribute("aria-expanded","false")),this.#d.querySelectorAll("a").forEach(t=>{t.contains(e.target)&&(this.#d.classList.remove("open"),this.#c.setAttribute("aria-expanded","false"))})}),this._setupKeyboardNavigation()}_setupKeyboardNavigation(){document.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||"BUTTON"!==e.target.tagName&&"A"!==e.target.tagName||(e.preventDefault(),e.target.click())})}async renderPage(){const e=l(d(u()));let t=c[e];t?document.startViewTransition?document.startViewTransition(async()=>{this.#s.innerHTML=await t.render(),await t.afterRender()}):(this.#s.classList.add("page-exit"),await new Promise(e=>setTimeout(e,300)),this.#s.innerHTML=await t.render(),this.#s.classList.remove("page-exit"),this.#s.classList.add("page-enter"),await t.afterRender(),setTimeout(()=>{this.#s.classList.remove("page-enter")},300)):window.location.hash="#/login"}};document.addEventListener("DOMContentLoaded",async()=>{const e=new a;try{await e.init(),console.log("[App] IndexedDB initialized")}catch(e){console.error("[App] Failed to initialize IndexedDB:",e)}const t=new s;try{await t.init()&&console.log("[App] Push notification service initialized")}catch(e){console.error("[App] Failed to initialize push notifications:",e)}const n=new h({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await n.renderPage(),window.addEventListener("hashchange",async()=>{await n.renderPage()}),window.addEventListener("online",()=>{console.log("[App] Online")}),window.addEventListener("offline",()=>{console.log("[App] Offline")})})}},n={};function i(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={exports:{}};return t[e].call(a.exports,a,a.exports,i),a.exports}i.m=t,e=[],i.O=(t,n,o,a)=>{if(!n){var r=1/0;for(l=0;l<e.length;l++){for(var[n,o,a]=e[l],s=!0,c=0;c<n.length;c++)(!1&a||r>=a)&&Object.keys(i.O).every(e=>i.O[e](n[c]))?n.splice(c--,1):(s=!1,a<r&&(r=a));if(s){e.splice(l--,1);var d=o();void 0!==d&&(t=d)}}return t}a=a||0;for(var l=e.length;l>0&&e[l-1][2]>a;l--)e[l]=e[l-1];e[l]=[n,o,a]},i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="/",(()=>{var e={792:0};i.O.j=t=>0===e[t];var t=(t,n)=>{var o,a,[r,s,c]=n,d=0;if(r.some(t=>0!==e[t])){for(o in s)i.o(s,o)&&(i.m[o]=s[o]);if(c)var l=c(i)}for(t&&t(n);d<r.length;d++)a=r[d],i.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return i.O(l)},n=self.webpackChunkapp_starter_project_with_webpack=self.webpackChunkapp_starter_project_with_webpack||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=i.O(void 0,[96],()=>i(551));o=i.O(o)})();
//# sourceMappingURL=main.39b33b2b02f888977a96.js.map